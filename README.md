# Identification of Attack Paths Using Kill Chain Attack Graphs (KCAGs) and SIEM alerts

This repository contains proof-of-concept implementation. It is a sligthly adjusted
version of our previous work (see the [original paper](https://doi.org/10.1109/NOMS54207.2022.9789803) and its 
[supplementary materials](https://doi.org/10.5281/zenodo.6367986)). New modules are
`evidence_path.py` and `final_report.py`. Module `input_convertor.py` contains completely new content. Other modules
contain adjusted functionality only where needed.

If you use or further modify this implementation, please use 
the following references to cite the original work:
* SADLEK, Lukáš; ČELEDA, Pavel; TOVARŇÁK, Daniel. Identification of Attack Paths Using Kill Chain and Attack Graphs.
In: NOMS 2022 - 2022 IEEE/IFIP Network Operations and Management Symposium. Budapest, Hungary: IEEE Xplore Digital
Library, 2022, pp. 1–6. Available from doi: 10.1109/NOMS54207.2022.9789803.
* SADLEK, Lukáš; ČELEDA, Pavel; TOVARŇÁK, Daniel. Supplementary Materials: Identification of Attack Paths Using Kill Chain
and Attack Graphs [online]. Zenodo, 2022 [visited on 2022-11-28].
Available from doi: 10.5281/zenodo.6367986.

The installation guide was inspired by our 
[previous work](https://www.muni.cz/en/research/publications/1724737).

## Structure of repository
The repository is structured into several folders. 
* Folder `inputs` contains input CSV files from the SIEM server. 
* Folder `outputs` contains important files present in the MulVAL working directory after execution of this 
implementation.
  * File `input_file.P` contains input for the MulVAL generator.
  * Files `AttackGraph.pdf` contains visualized attack graph.
  * Files `AttackGraph.txt` and `AttackGraph.xml` provide two forms of attack graph representation 
  for parsing.
  * Files `VERTICES.CSV` and `ARCS.CSV` contain vertices and edges from the attack graph.
* Folder `rules` contains the ruleset created using methodology described in the paper.

# Implementation of the method
The proof-of-concept implementation contains several files:
* `evidence_path.py` contains functionality that processes data from the SIEM server and
identifies sequences of attack techniques.
* `final_report.py` determines the final evaluation of the DEFCON levels for IP addresses and
sequences of attack techniques.
* `generator.py` contains procedure for generating the attack graph.
* `input_convertor.py` converts input CSV files into input files 
for MulVAL.
* `output_postprocessing.py` contains the KCAG generator. 
It processes the attack graph generated by MulVAL. It adds kill chain phases and labels for vertices. It also determines strategic phases, techniques,
and countermeasures.
* `run_mulval.py` contains utility that runs MulVAL from command line.
* `utils.py` contains utilities that return set of phases and mapping function of techniques.


## How to use
First, it is necessary to create input files for MulVAL. 
If your system contains created directory `/tmp/mulval_dir`, you can 
execute the following commands.
Note: the folder and file needs to exist.
Simply create the directory, and an empty file with the name of `input_file.P`.

```python
from input_convertor import convert_input
convert_input('/tmp/mulval_dir/input_file.P')
```

The next step is to generate the KCAG. The following commands will
output its attack paths, strategic techniques, and 
strategic countermeasures.

```python
from generator import generate_kcag
generate_kcag()
```

As the last step, it is necessary to process data from the SIEM server and determine
the DEFCON levels. This functionality is provided by the following commands.

```python
from evidence_path import process_restricted_files
process_restricted_files()
```

# Installation

Tips, use:
- openjdk-8-jdk (not sure if newer versions works with dom4j dependency. v8 does)
- ubuntu20.04 (22.04 uses too new version of c++ compiler)


It is necessary to install MulVAL:
```bash
$ wget -P /opt https://people.cs.ksu.edu/~xou/argus/software/mulval/mulval_1_1.tar.gz
$ cd /opt
$ tar -xzf mulval_1_1.tar.gz
$ rm mulval_1_1.tar.gz
```

MulVAL also requires XSB as installation prerequisite:
```bash
$ wget -P /opt http://xsb.sourceforge.net/downloads/XSB.tar.gz
$ tar -xzf XSB.tar.gz
$ rm XSB.tar.gz
```

Then you need to set environment variables for MulVAL and XSB. PATH must contain
paths to MulVAL and XSB.
```bash
$ export MULVALROOT=/opt/mulval
$ export XSBROOT=/opt/XSB
$ export PATH=$PATH:$MULVALROOT/bin:$MULVALROOT/utils:$XSBROOT/bin:$XSBROOT/build
```

It is necessary to compile XSB and MULVAL.
Install C++ compiler, Java, and bison and flex in you system. 
For C++ compiler, bison and flex:
```bash
$ apt-get install build-essential
$ apt-get install bison flex
```
You may also have to install `make` and `g++` if you don't have them already. (apt-get).


Now, you need to make XSB using these commands: 
```bash
$ cd XSB/build
$ ./configure
$ ./makexsb
```


After that you can test your XSB installation using
```bash
$ /opt/XSB/bin/xsb
```
and type `halt.` to exit XSB (with dot at the end).

Now, you need to compile MULVAL:
```bash
$ cd /opt/mulval
$ make
```

If output of `make` command contains `javac: Command not found` it means that you don't have Java installed in your
system or Java is not in your `PATH`. Note: you need JDK and in it `javac` command. Add to `PATH` the directory which
contains `javac` command. 

Open JDK may also require `dom4j` JAR package. Switch to folder for external java packages, 
which has usually form of `/usr/lib/jvm/<name of java>/jre/lib/ext` and then download the required JAR using:

```python
wget -P . https://github.com/dom4j/dom4j/releases/download/dom4j_1_6_1/dom4j-1.6.1.jar
```

After successful make of MULVAL you can run testing command (in MULVALROOT directory)
```bash
$ cd testcases/3host/
$ graph_gen.sh input.P -l -p
```

## Configuration file

You need to set variables in `conf.ini` before running the generator. 

* Set `mulval_root`/`xsb_root` variables to the same path you used when installing MULVAL / XSB. 
* Variable `mulval_dir` should contain location of directory in which the files necessary for AG generation will be created.
* Variable `interaction_rules_file` points to `rules/ruleset.P` file. Change its value only 
in a case you want to rename this file and rename the file appropriately.

## Requirements

Necessary requirements are listed in file `requirements.txt`. Functionality was 
tested with Python 3.9.
Install with `pip3 install -r requiremets.txt`. (requires pip3 to be installed)
